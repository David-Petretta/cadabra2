
def test01():
    __cdbkernel__ = create_scope()
    
    def post_process(ex):
        distribute(ex)
        eliminate_kronecker(ex)
        sort_product(ex)
        canonicalise(ex)
        collect_terms(ex)

    \delta{#}::KroneckerDelta;
    \GAMMA{#}::GammaMatrix;
    ex:=\GAMMA^{m} \GAMMA^{n p q} \GAMMA^{n p q m r} \delta^{a b} \delta^{c r};
    display(ex)
    tst:= \GAMMA^{m} \GAMMA^{n p q} \GAMMA^{n p q m c} \delta^{a b} - @(ex);
    display(tst)
    assert(tst==0)
    print("Test 01 passed")

test01()

def test02():
    def orderx(var, n):
        cn=Ex(n)
        drop_weight(var, $field=@(cn)$)
        return var

    {A,B,C}::Weight(label=field, value=1);
    ex:=A B C + A B + A A + A C + A B C D;
    orderx(ex, 2)
    tst:= A B C + A B C D - @(ex);
    assert(tst==0)
    print("Test 02 passed")

test02()

def test03():
    __cdbkernel__ = create_scope()
    ex:= Q Q Q Q Q Q;
    converge(ex):
        substitute(_, $Q->A+B, A B->3$, repeat=True)
        distribute(_)
        
    tst:= A A A A A A + 18 A A A A + 135 A A + 540 + 18 B B B B + 135 B B + B B B B B B - @(ex);
    assert(tst==0)
    print("Test 03 passed")

test03()



\partial{#}::PartialDerivative;        
ex:=A_{m n} \partial_{r}{ B^{m n} } \partial^{r}{ Q } + \partial_{m}{ A^{m} } R;  
num=1
for partial in ex["\\partial"]:
    partial.name="k"+str(num)
    num+=1

ex;
    
# this one still not working?! Does not stop and restart at second product.
\partial{#}::PartialDerivative;        
ex:=A_{m n} \partial_{r}{ B^{m n} } \partial^{r}{ Q } + \partial_{m}{ A^{m} } R;  
for prod in ex["\\prod"]:
    num=1
    for partial in prod["\\partial"]:
        partial.name="k"+str(num)
        num+=1

ex;
print(tree(ex))
    

\partial{#}::PartialDerivative;        
ex:=A_{m n} \partial_{r}{ 3 B^{m n} } \partial^{r}{ 2 Q } + \partial_{m}{ 5 A^{m} } R;  
for prod in ex["\\prod"]:
    num=1
    for partial in prod["\\partial"]:
        for index in partial.indices():
            print(index)
            num+=1

ex;
print(tree(ex))
  

\partial{#}::PartialDerivative;        
ex:=A_{m n} \partial_{r}{ B_{p q} } \partial_{s}{ C } ;
for prod in ex["\\prod"]:
    num=1
    for partial in prod["\\partial"]:
        for index in partial.indices():
            k = Ex("k"+str(num)+"_{"+index.name+"}")
            partial.insert(k)
        for arg in partial.args():
            partial.insert(arg)
        partial.erase()

ex;
